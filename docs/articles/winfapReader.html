<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An introduction to winfapReader • winfapReader</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="An introduction to winfapReader">
<meta property="og:description" content="winfapReader">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">winfapReader</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1-3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/winfapReader.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ilapros/winfapReader/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="winfapReader_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>An introduction to winfapReader</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ilapros/winfapReader/blob/master/vignettes/winfapReader.Rmd"><code>vignettes/winfapReader.Rmd</code></a></small>
      <div class="hidden name"><code>winfapReader.Rmd</code></div>

    </div>

    
    
<p>The <code>winfapReader</code> package contains functions to interact with the information on extremes of instantaneous river flow in the United Kingdom (UK) made available by the <a href="https://nrfa.ceh.ac.uk">National River Flow Archive</a> (NRFA). These information underlie most flood risk estimation projects in the UK, which are typically carried out using the <a href="https://www.ceh.ac.uk/services/flood-estimation-handbook">Flood Estimation Handbook</a> (FEH) statistical method and their <a href="https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/291096/scho0608boff-e-e.pdf">updates</a> as implemented by the software <a href="https://www.hydrosolutions.co.uk/software/winfap-4/">WINFAP</a>. Consequently, the NRFA publishes and routinely updates files which are suitable to be read by WINFAP: the collection of these files is referred to as the peak flow dataset and can be found <a href="https://nrfa.ceh.ac.uk/peak-flow-dataset">here</a>. The winfapReader package allows the user to interact with three different file-types:</p>
<ul>
<li><p>The .AM files which contain the Annual Maximum (AMAX) peaks: these correspond to the largest river flow event in any given water year (which runs from October 1st to September 30th)</p></li>
<li><p>The .CD3 files which contain the Catchment Descriptors: these correspond to a set of descriptors for the catchment upstream the gauging station and for the station itself.</p></li>
<li><p>The .PT files which contain the peaks over threshold: these correspond to all peaks which are larger than a given threshold. The threshold is fixed by the NRFA and it should be such that there is an average of 3 to 5 peaks over threshold (POT) events per water year. It has often been reported that the POT records in different stations have varying reliability: since most flood frequency estimation methods used in the UK rely on annual maxima the AMAX records go trough a higher scrutiny than then POT records. Users should treat the information about peaks over threshold with caution and thorough quality checks should be performed before analysing them.</p></li>
</ul>
<p>The <code>winfapReader</code> package allows you to read into your R session the <code>.AM</code>, <code>.CD3</code> and<code>.PT</code> files. Importantly it is aware of the typical structure of the files in which rejected annual maxima and missing period of records for the peaks over threshold are recorded, and merges this information with the flow records. This allows the user to have all useful information to decide which parts of the record to include in the analysis.</p>
<p>Recently the NRFA has developed an <a href="https://nrfa.ceh.ac.uk/news-and-media/news/nrfa-releases-api-improve-data-access">API</a> which allows for a programmatic interaction with their datasets: the information about annual maxima, catchment descriptors and peaks over threshold can also be retrieved using this API. Beside the information on extremes for flood frequency estimation the NRFA maintains and distributes daily river flow records and several other river flow related variables, such as catchment averaged rainfall: the <a href="https://cran.r-project.org/package=rnrfa"><code>rnrfa</code></a> package allows one to retrieve these information and more with its <code><a href="http://cvitolo.github.io/rnrfa/reference/gdf.html">rnrfa::gdf</a></code> and <code><a href="http://cvitolo.github.io/rnrfa/reference/get_ts.html">rnrfa::get_ts</a></code> functions (see more on this at the end of the vignette). The <code>winfapReader</code> package focuses only on handling river flow extremes information and has two sets of functions:</p>
<ul>
<li><p>the <code>read_amax</code>, <code>read_cd3</code> and <code>read_pot</code> functions read the information from the <code>.AM</code>, <code>.CD3</code> and <code>.PT</code> files <em>once these have been downloaded into a local folder</em></p></li>
<li><p>the <code>get_amax</code>, <code>get_cd</code> and <code>get_pot</code> functions get the information from the API: these functions therefore only work when an internet connection is available</p></li>
</ul>
<p>It is difficult to showcase the use of the <code>read_*</code> functions since these rely on the location of the WINFAP files within the users’ working environment. Only the use of the <code>get_*</code> function will be showcased below. For the annual maxima and peaks over threshold the two sets of functions give the same output.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ilapros.github.io/winfapReader/">winfapReader</a></span><span class="op">)</span>
<span class="co">### the get_* functions only works once you are connected to the internet</span>
<span class="co">### they also need one to have the library httr installed </span>
<span class="co">### verify if you have the library with (!requireNamespace("httr", quietly = TRUE)) </span>
<span class="co">### if FALSE install it with </span>
<span class="co">### install.packages("httr")</span></pre></div>
<div id="the-get_amaxfunction" class="section level3">
<h3 class="hasAnchor">
<a href="#the-get_amaxfunction" class="anchor"></a>The <code>get_amax</code>function</h3>
<p>The <code>get_amax</code> function allows one to obtain information on annual maxima from the NRFA. The <code>read_amax</code> function will produce the same output as the <code>get_amax</code> function but is based on the locally saved files.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">if</span><span class="op">(</span><span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.cran.dev/curl/reference/nslookup.html">has_internet</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="va">amaxEx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_amax.html">get_amax</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">42003</span>,<span class="fl">72014</span><span class="op">)</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">amaxEx</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">amaxEx</span><span class="op">)</span>
<span class="co">#&gt; [1] "42003" "72014"</span>
<span class="co">#&gt; [1] "list"</span>
<span class="co"># let's look at only one of these</span>
<span class="va">a42003</span> <span class="op">&lt;-</span> <span class="va">amaxEx</span><span class="op">[[</span><span class="st">"42003"</span><span class="op">]</span><span class="op">]</span>
<span class="co">## what is the output</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">a42003</span><span class="op">)</span>
<span class="co">#&gt;   Station WaterYear       Date  Flow Stage Rejected</span>
<span class="co">#&gt; 1   42003      1975 1976-09-30  4.16 -9999     TRUE</span>
<span class="co">#&gt; 2   42003      1976 1977-02-10 13.60 -9999     TRUE</span>
<span class="co">#&gt; 3   42003      1977 1977-12-10 14.90 -9999     TRUE</span>
<span class="co">#&gt; 4   42003      1978 1978-12-10 11.60 -9999     TRUE</span>
<span class="co">#&gt; 5   42003      1979 1979-12-27  9.92 -9999     TRUE</span>
<span class="co">#&gt; 6   42003      1980 1980-10-15 11.30 -9999     TRUE</span></pre></div>
<p>For each station the function outputs a <code>data.frame</code> with information on the station number, the water year, the date in which the highest flow in the water year was recorded, the river flow value and the river stage value (when available) for all annual maxima recorded at a station. Moreover it gives the information on whether the NRFA has deemed the maximum in a given year to be reliable or whether this has been rejected. The function can query the API for more than one station at the time: in that case the output is a named list with each element corresponding to a station id.</p>
</div>
<div id="the-get_potfunction" class="section level3">
<h3 class="hasAnchor">
<a href="#the-get_potfunction" class="anchor"></a>The <code>get_pot</code>function</h3>
<p>The <code>get_pot</code> function allows one to obtain information on peaks over threshold data from the NRFA. The <code>read_pot</code> function will produce the same output as the <code>get_pot</code> function but is based on the locally saved files.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">if</span><span class="op">(</span><span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.cran.dev/curl/reference/nslookup.html">has_internet</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="va">potEx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_pot.html">get_pot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">42003</span>,<span class="fl">72014</span><span class="op">)</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">potEx</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">potEx</span><span class="op">)</span>
<span class="co">#&gt; [1] "42003" "72014"</span>
<span class="co">#&gt; [1] "list"</span>
<span class="co"># let's look at only one of these</span>
<span class="va">p42003</span> <span class="op">&lt;-</span> <span class="va">potEx</span><span class="op">[[</span><span class="st">"42003"</span><span class="op">]</span><span class="op">]</span>
<span class="co">## what is the output</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">p42003</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">p42003</span><span class="op">)</span>
<span class="co">#&gt; [1] "list"</span>
<span class="co">#&gt; [1] "tablePOT"      "WaterYearInfo" "dateRange"</span></pre></div>
<p>For each station the function outputs a list with three elements:</p>
<ul>
<li>
<code>tablePOT</code>: a <code>data.frame</code> with all the recorded exceedances above the threshold in the NRFA record. In particular information on the exceedance date, water year, peak flow and river stage are given.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">p42003</span><span class="op">$</span><span class="va">tablePOT</span><span class="op">)</span>
<span class="co">#&gt;   Station       Date WaterYear Flow Stage</span>
<span class="co">#&gt; 1   42003 1982-10-14      1982 17.0 1.381</span>
<span class="co">#&gt; 2   42003 1982-10-22      1982 19.4 1.486</span>
<span class="co">#&gt; 3   42003 1982-11-24      1982 15.5 1.314</span>
<span class="co">#&gt; 4   42003 1982-12-09      1982 20.2 1.516</span>
<span class="co">#&gt; 5   42003 1985-01-20      1984 23.6 1.656</span>
<span class="co">#&gt; 6   42003 1986-11-21      1986 14.8 1.283</span>
<span class="co">## notice: several events in the 1982 no events in 1983</span></pre></div>
<ul>
<li>
<code>WaterYearInfo</code>: a <code>data.frame</code> with information on the percentage of valid record in each water year in the record. The potPercComplete column is derived by calculating the percentage of days which are not included in the POT Gaps or the POT rejected headers in the NRFA .PT files. The column potThreshold gives the information of the flow threshold used to extract the peaks for the station: this is a constant for each station.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">p42003</span><span class="op">$</span><span class="va">WaterYearInfo</span><span class="op">)</span>
<span class="co">#&gt;   WaterYear potPercComplete potThreshold</span>
<span class="co">#&gt; 1      1982               0       14.497</span>
<span class="co">#&gt; 2      1983               0       14.497</span>
<span class="co">#&gt; 3      1984               0       14.497</span>
<span class="co">#&gt; 4      1985               0       14.497</span>
<span class="co">#&gt; 5      1986               0       14.497</span>
<span class="co">#&gt; 6      1987               0       14.497</span></pre></div>
<ul>
<li>
<code>dateRange</code> gives the range of dates spanned by the POT record. This range might be wider than the range of the dates in the <code>tablePOT</code> table since it records the period in which the station was operational and no threshold exceedances occurred.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="op">(</span><span class="va">p42003</span><span class="op">$</span><span class="va">dateRange</span><span class="op">)</span>
<span class="co">#&gt; [1] "1982-10-13" "2019-02-10"</span></pre></div>
<p>The function has an argument <code>getAmax</code> which defaults to <code>FALSE</code>. If <code>getAmax = TRUE</code> then information on the annual maxima is included in the <code>WaterYearInfo</code> table.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">p42003withAmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_pot.html">get_pot</a></span><span class="op">(</span><span class="fl">42003</span>, getAmax <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">p42003withAmax</span><span class="op">$</span><span class="va">WaterYearInfo</span>, <span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt;    Station WaterYear   amaxDate amaxFlow amaxStage amaxRejected potPercComplete</span>
<span class="co">#&gt; 1    42003      1975 1976-09-30     4.16 -9999.000         TRUE              NA</span>
<span class="co">#&gt; 2    42003      1976 1977-02-10    13.60 -9999.000         TRUE              NA</span>
<span class="co">#&gt; 3    42003      1977 1977-12-10    14.90 -9999.000         TRUE              NA</span>
<span class="co">#&gt; 4    42003      1978 1978-12-10    11.60 -9999.000         TRUE              NA</span>
<span class="co">#&gt; 5    42003      1979 1979-12-27     9.92 -9999.000         TRUE              NA</span>
<span class="co">#&gt; 6    42003      1980 1980-10-15    11.30 -9999.000         TRUE              NA</span>
<span class="co">#&gt; 7    42003      1981 1981-12-14     8.32 -9999.000         TRUE              NA</span>
<span class="co">#&gt; 8    42003      1982 1982-12-09    20.20     1.516         TRUE               0</span>
<span class="co">#&gt; 9    42003      1983 1983-12-22    11.70     1.134         TRUE               0</span>
<span class="co">#&gt; 10   42003      1984 1985-01-20    23.60     1.656         TRUE               0</span>
<span class="co">#&gt;    potThreshold</span>
<span class="co">#&gt; 1            NA</span>
<span class="co">#&gt; 2            NA</span>
<span class="co">#&gt; 3            NA</span>
<span class="co">#&gt; 4            NA</span>
<span class="co">#&gt; 5            NA</span>
<span class="co">#&gt; 6            NA</span>
<span class="co">#&gt; 7            NA</span>
<span class="co">#&gt; 8        14.497</span>
<span class="co">#&gt; 9        14.497</span>
<span class="co">#&gt; 10       14.497</span></pre></div>
<p>Notice that in the period when no POT records are available all POT related information are set to NA. On the other hand, the fact that the annual maximum in water year 1983 is below the threshold confirms that the fact that no POT record are present for that water year is related to low flows throughout the water year rather than a mistake in the POT record. Notice also that for several of the first years in the record the annual maxima values are rejected and the proportion of valid POT records (as shown by <code>potPercComplete</code>) is null: the early part of the record for this station has been deemed by the NRFA to be unreliable and any analysis of this flow record should probably discard the information till water year 1995.</p>
</div>
<div id="the-get_cdfunction" class="section level3">
<h3 class="hasAnchor">
<a href="#the-get_cdfunction" class="anchor"></a>The <code>get_cd</code>function</h3>
<p>The <code>get_cd</code> function allows the user to obtain information on the station (for example its location) and on the catchment upstream the station itself (for example the catchment area and the annual mean altitude for the catchment). More detail on several of the catchment descriptors can be found on the <a href="https://nrfa.ceh.ac.uk/about-data">NRFA website</a> and in the FEH. The function gives a slightly different set of information than the <code>read_cd3</code> function, due to the difference in information made available by the NRFA API.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">if</span><span class="op">(</span><span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.cran.dev/curl/reference/nslookup.html">has_internet</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="va">cdEx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cd.html">get_cd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">42003</span>,<span class="fl">72014</span><span class="op">)</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cdEx</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">cdEx</span><span class="op">)</span>
<span class="co">#&gt; [1] "42003" "72014"</span>
<span class="co">#&gt; [1] "list"</span>
<span class="co"># let's look at only one of these</span>
<span class="va">c42003</span> <span class="op">&lt;-</span> <span class="va">cdEx</span><span class="op">[[</span><span class="st">"42003"</span><span class="op">]</span><span class="op">]</span>
<span class="co">## what is the output</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">c42003</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">c42003</span><span class="op">)</span>
<span class="co">#&gt; [1] "data.frame"</span>
<span class="co">#&gt;  [1] "id"                   "river"                "location"            </span>
<span class="co">#&gt;  [4] "easting"              "northing"             "latitude"            </span>
<span class="co">#&gt;  [7] "longitude"            "feh-pooling"          "feh-qmed"            </span>
<span class="co">#&gt; [10] "feh-neither"          "benchmark"            "propwet"             </span>
<span class="co">#&gt; [13] "bfihost"              "farl"                 "dpsbar"              </span>
<span class="co">#&gt; [16] "sprhost"              "rmed-1d"              "rmed-2d"             </span>
<span class="co">#&gt; [19] "rmed-1h"              "ldp"                  "dplbar"              </span>
<span class="co">#&gt; [22] "altbar"               "aspbar"               "aspvar"              </span>
<span class="co">#&gt; [25] "ihdtm-height"         "ihdtm-catchment-area" "hydrometric-area"    </span>
<span class="co">#&gt; [28] "qmed"</span></pre></div>
<p>The function has an argument <code>fields</code> which governs the amount of information obtained from the API. If <code>fields = "feh"</code> (the default) only the basic information used in the FEH methods is output. If <code>fields="all"</code> a data.frame with 104 columns is output. This contains several information about the station and the catchment, including data availability, land cover information and much more.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">if</span><span class="op">(</span><span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.cran.dev/curl/reference/nslookup.html">has_internet</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="va">cd42003all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cd.html">get_cd</a></span><span class="op">(</span><span class="fl">42003</span>, fields <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cd42003all</span><span class="op">)</span>
<span class="co">#&gt;   [1] "id"                             "name"                          </span>
<span class="co">#&gt;   [3] "catchment-area"                 "river"                         </span>
<span class="co">#&gt;   [5] "location"                       "station-level"                 </span>
<span class="co">#&gt;   [7] "measuring-authority-id"         "measuring-authority-station-id"</span>
<span class="co">#&gt;   [9] "hydrometric-area"               "opened"                        </span>
<span class="co">#&gt;  [11] "closed"                         "station-type"                  </span>
<span class="co">#&gt;  [13] "bankfull-flow"                  "structurefull-flow"            </span>
<span class="co">#&gt;  [15] "sensitivity"                    "nrfa-mean-flow"                </span>
<span class="co">#&gt;  [17] "nrfa-peak-flow"                 "feh-pooling"                   </span>
<span class="co">#&gt;  [19] "feh-qmed"                       "feh-neither"                   </span>
<span class="co">#&gt;  [21] "nhmp"                           "benchmark"                     </span>
<span class="co">#&gt;  [23] "live-data"                      "factors-affecting-runoff"      </span>
<span class="co">#&gt;  [25] "gdf-start-date"                 "gdf-end-date"                  </span>
<span class="co">#&gt;  [27] "gdf-mean-flow"                  "gdf-min-flow"                  </span>
<span class="co">#&gt;  [29] "gdf-first-date-of-min"          "gdf-last-date-of-min"          </span>
<span class="co">#&gt;  [31] "gdf-max-flow"                   "gdf-first-date-of-max"         </span>
<span class="co">#&gt;  [33] "gdf-last-date-of-max"           "gdf-q95-flow"                  </span>
<span class="co">#&gt;  [35] "gdf-q70-flow"                   "gdf-q50-flow"                  </span>
<span class="co">#&gt;  [37] "gdf-q10-flow"                   "gdf-q05-flow"                  </span>
<span class="co">#&gt;  [39] "gdf-base-flow-index"            "gdf-day-count"                 </span>
<span class="co">#&gt;  [41] "gdf-flow-count"                 "gdf-percent-complete"          </span>
<span class="co">#&gt;  [43] "peak-flow-start-date"           "peak-flow-end-date"            </span>
<span class="co">#&gt;  [45] "qmed"                           "minimum-altitude"              </span>
<span class="co">#&gt;  [47] "10-percentile-altitude"         "50-percentile-altitude"        </span>
<span class="co">#&gt;  [49] "90-percentile-altitude"         "maximum-altitude"              </span>
<span class="co">#&gt;  [51] "saar-1941-1970"                 "saar-1961-1990"                </span>
<span class="co">#&gt;  [53] "lcm2000-woodland"               "lcm2000-arable-horticultural"  </span>
<span class="co">#&gt;  [55] "lcm2000-grassland"              "lcm2000-mountain-heath-bog"    </span>
<span class="co">#&gt;  [57] "lcm2000-urban"                  "lcm2007-woodland"              </span>
<span class="co">#&gt;  [59] "lcm2007-arable-horticultural"   "lcm2007-grassland"             </span>
<span class="co">#&gt;  [61] "lcm2007-mountain-heath-bog"     "lcm2007-urban"                 </span>
<span class="co">#&gt;  [63] "high-perm-bedrock"              "moderate-perm-bedrock"         </span>
<span class="co">#&gt;  [65] "low-perm-bedrock"               "mixed-perm-bedrock"            </span>
<span class="co">#&gt;  [67] "high-perm-superficial"          "low-perm-superficial"          </span>
<span class="co">#&gt;  [69] "mixed-perm-superficial"         "propwet"                       </span>
<span class="co">#&gt;  [71] "bfihost"                        "farl"                          </span>
<span class="co">#&gt;  [73] "dpsbar"                         "sprhost"                       </span>
<span class="co">#&gt;  [75] "rmed-1d"                        "rmed-2d"                       </span>
<span class="co">#&gt;  [77] "rmed-1h"                        "ldp"                           </span>
<span class="co">#&gt;  [79] "dplbar"                         "altbar"                        </span>
<span class="co">#&gt;  [81] "aspbar"                         "aspvar"                        </span>
<span class="co">#&gt;  [83] "ihdtm-height"                   "ihdtm-catchment-area"          </span>
<span class="co">#&gt;  [85] "mean-flood-plain-depth"         "mean-flood-plain-location"     </span>
<span class="co">#&gt;  [87] "mean-flood-plain-extent"        "urbext-1990"                   </span>
<span class="co">#&gt;  [89] "urbconc-1990"                   "urbloc-1990"                   </span>
<span class="co">#&gt;  [91] "urbext-2000"                    "urbconc-2000"                  </span>
<span class="co">#&gt;  [93] "urbloc-2000"                    "easting"                       </span>
<span class="co">#&gt;  [95] "northing"                       "latitude"                      </span>
<span class="co">#&gt;  [97] "longitude"                      "grid-reference.ngr"            </span>
<span class="co">#&gt;  [99] "grid-reference.easting"         "grid-reference.northing"       </span>
<span class="co">#&gt; [101] "lat-long.string"                "lat-long.latitude"             </span>
<span class="co">#&gt; [103] "lat-long.longitude"             "peak-flow-rejected-amax-years"</span></pre></div>
</div>
<div id="combining-the-winfapreader-and-rnrfa-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#combining-the-winfapreader-and-rnrfa-packages" class="anchor"></a>Combining the <code>winfapReader</code> and <code>rnrfa</code> packages</h3>
<p>The <code>rnrfa</code> package provides a unique way to query several types of data from the NRFA. Information about extremes can also be retrieved using the <code>rnrfa</code> package, although there are some differences in the output provided when the data of interest are the peaks over threshold records.</p>
<!-- When it comes to river extremes though, the `winfapReader` functions leverage the additional information available about rejected records and periods of missing records, thus giving the user a more complete information on which parts of the extremes series are reliable. The two packages can be used in combination by those who are interested in investigating in depth the behaviour of river flow extremes in the UK.  -->
<p>The <code><a href="http://cvitolo.github.io/rnrfa/reference/catalogue.html">rnrfa::catalogue</a></code> function allows one to pull the list of stations (and related metadata), falling within a given bounding box. The metadata retrieved by the function are similar to the ones derived from <code><a href="../reference/get_cd.html">winfapReader::get_cd</a></code>. This function can be used to identify the stations in an area for which peak flow information can be obtained with <code>winfapReader</code>. The code below for example identifies stations surrounding the city of Lancaster and then displays the annual maxima flow with red lines indicating Rejected flow values. Notice that you would need to have the <code>rnrfa</code> package installed for the code below to work.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="co">## Lancaster coordinates:  54.04, -2.8</span>
<span class="co">## let's look around the city</span>
<span class="va">rivLanc</span> <span class="op">&lt;-</span> <span class="fu">rnrfa</span><span class="fu">::</span><span class="fu"><a href="http://cvitolo.github.io/rnrfa/reference/catalogue.html">catalogue</a></span><span class="op">(</span>bbox <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lat_min <span class="op">=</span> <span class="fl">54.04</span><span class="op">-</span><span class="fl">0.2</span>, lat_max <span class="op">=</span> <span class="fl">54.04</span><span class="op">+</span><span class="fl">0.2</span>, 
                                        lon_min <span class="op">=</span> <span class="op">-</span><span class="fl">2.8</span><span class="op">-</span><span class="fl">0.2</span>, lon_max <span class="op">=</span> <span class="op">-</span><span class="fl">2.8</span><span class="op">+</span><span class="fl">0.2</span><span class="op">)</span><span class="op">)</span>
<span class="co">### let's select stations which have been deemed to be suitable for pooling</span>
<span class="co">### that's the highest quality flag for annual maxima </span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">rivLanc</span><span class="op">[</span>,<span class="st">"feh-pooling"</span><span class="op">]</span><span class="op">)</span> <span class="co">### 5 stations are suitable for pooling</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; FALSE  TRUE </span>
<span class="co">#&gt;     5     5</span>
<span class="va">rivLanc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">rivLanc</span>,subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">rivLanc</span><span class="op">[</span>,<span class="st">"feh-pooling"</span>,drop<span class="op">=</span><span class="cn">TRUE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">rivLanc</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 5 x 3</span>
<span class="co">#&gt;      id name                    `catchment-area`</span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;                              &lt;dbl&gt;</span>
<span class="co">#&gt; 1 72004 Lune at Caton                      983  </span>
<span class="co">#&gt; 2 72007 Brock at upstream of A6             32  </span>
<span class="co">#&gt; 3 72014 Conder at Galgate                   28.5</span>
<span class="co">#&gt; 4 73008 Bela at Beetham                    131  </span>
<span class="co">#&gt; 5 73015 Keer at High Keer Weir              48</span>
<span class="co">### notice that rnrfa outputs a tibble and not a data.frame</span>
<span class="va">idLanc</span> <span class="op">&lt;-</span> <span class="va">rivLanc</span><span class="op">[</span>,<span class="st">"id"</span>,drop<span class="op">=</span><span class="cn">TRUE</span><span class="op">]</span> <span class="co">## a vector of ids</span>
<span class="va">amaxLanc</span> <span class="op">&lt;-</span> <span class="fu">winfapReader</span><span class="fu">::</span><span class="fu"><a href="../reference/get_amax.html">get_amax</a></span><span class="op">(</span><span class="va">idLanc</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">amaxLanc</span><span class="op">)</span>
<span class="co">#&gt; [1] "72004" "72007" "72014" "73008" "73015"</span></pre></div>
<p>Now display the stations all together in a panel.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">amaxLanc</span>, 
       <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">x</span>,<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">WaterYear</span>,<span class="va">Flow</span>,
                               type<span class="op">=</span><span class="st">"h"</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">Rejected</span>,<span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span>, 
                               main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">Station</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="winfapReader_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The large events which have hit the area in 2015 can be seen in the flow series plots.</p>
<p>The <code>rnrfa</code> package also allows to pull the annual maximum flow recorded at any station. To also obtain the information about the water year which the NRFA has deemed to be of poor quality and therefore rejected set the <code>full_info</code> argument to <code>TRUE</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">### the annual maxima for 72014 from rnrfa</span>
<span class="va">maxflow72014</span> <span class="op">&lt;-</span> <span class="fu">rnrfa</span><span class="fu">::</span><span class="fu"><a href="http://cvitolo.github.io/rnrfa/reference/get_ts.html">get_ts</a></span><span class="op">(</span><span class="fl">72014</span>, type <span class="op">=</span> <span class="st">"amax-flow"</span>, full_info <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> 
<span class="co">### the annual maxima for 72014 from winfapReader</span>
<span class="va">xx</span> <span class="op">&lt;-</span> <span class="va">amaxLanc</span><span class="op">[[</span><span class="st">"72014"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Date"</span>,<span class="st">"Flow"</span>,<span class="st">"Rejected"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">xx</span><span class="op">[</span>,<span class="st">"Flow"</span><span class="op">]</span>, <span class="va">maxflow72014</span><span class="op">[</span>,<span class="st">"amax-flow"</span><span class="op">]</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">### same information </span></pre></div>
<p><img src="winfapReader_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">xx</span><span class="op">$</span><span class="va">Rejected</span><span class="op">)</span> <span class="co">## but two years should be rejected</span>
<span class="co">#&gt; [1]  1 25</span>
<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">maxflow72014</span><span class="op">$</span><span class="va">rejected</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co">## same two years</span>
<span class="co">#&gt; [1]  1 25</span></pre></div>
<p>To obtain the POT records in <code>rnrfa</code> use <code>type = "pot-flow"</code>: using the <code>full_info = TRUE</code> option ensures that a rejected flag is given for the periods in which the POT records have been found to be unreliable or missing (see the NRFA website for more details on this). The <code>rejected</code> flag is built using the same information used to build the <code>WaterYearInfo</code> table in the <code><a href="../reference/get_pot.html">winfapReader::get_pot</a></code> function. The additional information provided in <code>WaterYearInfo</code> is useful to identify the years in which no POT record is found because the records are missing/unreliable and not because the threshold was never exceeded.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co"># the pot records for 75001 from rnrfa</span>
<span class="va">pot75001</span> <span class="op">&lt;-</span> <span class="fu">rnrfa</span><span class="fu">::</span><span class="fu"><a href="http://cvitolo.github.io/rnrfa/reference/get_ts.html">get_ts</a></span><span class="op">(</span><span class="fl">75001</span>, type <span class="op">=</span> <span class="st">"pot-flow"</span>, full_info <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">pot75001</span><span class="op">[</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span>,<span class="op">]</span>
<span class="co">#&gt;            pot-flow rejected</span>
<span class="co">#&gt; 1975-01-27   16.243        0</span>
<span class="co">#&gt; 1975-01-31   18.366        0</span>
<span class="co">#&gt; 1977-02-04    7.939        0</span>
<span class="co">#&gt; 1977-02-07    8.913        0</span>
<span class="co"># using winfapReader</span>
<span class="va">p75001</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_pot.html">get_pot</a></span><span class="op">(</span><span class="fl">75001</span><span class="op">)</span>
<span class="va">p75001</span><span class="op">$</span><span class="va">tablePOT</span><span class="op">[</span><span class="fl">9</span><span class="op">:</span><span class="fl">12</span>,<span class="op">]</span>
<span class="co">#&gt;    Station       Date WaterYear   Flow Stage</span>
<span class="co">#&gt; 9    75001 1975-01-27      1974 16.243 0.910</span>
<span class="co">#&gt; 10   75001 1975-01-31      1974 18.366 0.960</span>
<span class="co">#&gt; 11   75001 1977-02-04      1976  7.939 0.676</span>
<span class="co">#&gt; 12   75001 1977-02-07      1976  8.913 0.708</span>
<span class="co"># the same peaks are identified</span>
<span class="va">p75001</span><span class="op">$</span><span class="va">WaterYearInfo</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="op">]</span> <span class="co">### but notice that 1975 had a low proportion missing records</span>
<span class="co">#&gt;   WaterYear potPercComplete potThreshold</span>
<span class="co">#&gt; 1      1973        63.28767        6.366</span>
<span class="co">#&gt; 2      1974        98.63014        6.366</span>
<span class="co">#&gt; 3      1975        99.18033        6.366</span>
<span class="co">#&gt; 4      1976       100.00000        6.366</span>
<span class="co">#&gt; 5      1977        97.80822        6.366</span>
<span class="co">#  the lack of data in 1975 is due to all flow being low</span></pre></div>
<p>The two packages can be used together to retrieve different type of information about river flow: in the example below daily gauged flow for the Conder at Galgate (station 72014) is displayed together with annual maxima (which are extracted from the instantaneous river flow). The latter are typically larger and can be seen to start further in the past than the daily flow data.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="co">### get daily data from NRFA </span>
<span class="va">daily72014</span> <span class="op">&lt;-</span> <span class="fu">rnrfa</span><span class="fu">::</span><span class="fu"><a href="http://cvitolo.github.io/rnrfa/reference/get_ts.html">get_ts</a></span><span class="op">(</span><span class="fl">72014</span>, type <span class="op">=</span> <span class="st">"gdf"</span><span class="op">)</span> 
<span class="co">## make daily data into data.frame </span>
<span class="va">daily72014</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Day <span class="op">=</span> <span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/index.html">index</a></span><span class="op">(</span><span class="va">daily72014</span><span class="op">)</span>, 
                         DFlow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">daily72014</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">xx</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Date"</span>,<span class="st">"Flow"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">xx</span><span class="op">$</span><span class="va">Rejected</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,
     pch <span class="op">=</span> <span class="fl">4</span>, ylim <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1.05</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">xx</span><span class="op">$</span><span class="va">Flow</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"The Conder at Galgate"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">daily72014</span>, type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></pre></div>
<p><img src="winfapReader_files/figure-html/dayAndAmax-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ilaria Prosdocimi, Luke Shaw.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
